{
  "type": "Task",
  "status": "todo",
  "project": "DynamicBlockRenderers",
  "name": "orval + zod client + autoâ€‘renderer stubs",
  "description": "Replace handâ€‘written fetch helpers with orvalâ€‘generated hooks & zod validation.  Autoâ€‘generate block render stubs from backend schema index.",
  "action_items": [
    "## ğŸ”Œ  ORVAL CLIENT",
    "[ ] **Install deps**  âœ  `npm i -D orval@latest zod openapi-typescript`.",
    "[ ] **orval.config.js**  âœ\n```js\nexport default {\n  output: {\n    mode: 'tags',                        // hooks per tag (Chat, Blocks)\n    target: 'src/api',                  // generated code goes here\n    schemas: 'src/api/schemas',         // zod schemas emitted here\n    client: 'fetch-zod'                 // zod runtime validation!\n  },\n  input: './schemas/api/openapi.json',  // path committed by backend script\n  hooks: {\n    afterAllFilesWrite: ['npm run gen:renderers']\n  }\n};\n```",
    "[ ] **package.json scripts**  âœ  `{ \"gen:api\": \"orval\", \"gen:renderers\": \"ts-node scripts/gen-renderers.ts\" }`.",
    "## ğŸ–¼ï¸  RENDERER STUB GENERATOR",
    "[ ] **scripts/gen-renderers.ts**  âœ  Fetch `/schemas/index.json` (local file committed by backend export) and for each unseen `{type,version}` write `components/block_renderers/{type}.v{version}.tsx` with a minimal `<pre>` placeholder.",
    "[ ] **Dynamic loader**  âœ  In `lib/blockRendererRegistry.ts`, use `import.meta.glob('./components/block_renderers/*.tsx')` (lazy) to map filenames `{type}.v{ver}.tsx` â†’ renderer.",
    "## ğŸ§¹  REMOVE AJV",
    "[ ] Delete `utils/validateInput.ts` and Ajv glue. orval hooks return zodâ€‘validated data automatically.",
    "## ğŸ”„  PIPELINE",
    "[ ] Update CI: `npm run gen:api` must run after `backend/export_openapi.py`. Fail build if `git diff --exit-code schemas/ src/api/` is nonâ€‘zero.",
    "## ğŸ› ï¸  CODE MOD",
    "[ ] Replace manual `fetchBlocks()` and `createChatRequest()` usages with generated hooks:  `const { data, error } = useGetApiBlocks();`, `await postChatChat(data)`."
  ],
  "success_criteria": [
    "â€¢ Running `npm run gen:api` produces `src/api/*` hooks and zod schemas without errors.",
    "â€¢ BlockRenderer dynamically imports newly scaffolded `*.tsx` files and shows UnknownBlock only for truly unsupported versions.",
    "â€¢ Manual Ajv code is gone; runtime validation errors surface from zod.",
    "â€¢ CI fails if schemas or renderers drift."
  ],
  "priority": "high"
}
